<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ShiftPay</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b1220">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
  :root{
    --bg:#0b1220;
    --line:rgba(255,255,255,0.10);
    --text:rgba(255,255,255,0.92);
    --muted:rgba(255,255,255,0.65);

    --purple:#7c3aed;
    --green:#22c55e;
    --amber:#f59e0b;
    --blue:#3b82f6;
    --pink:#ec4899;

    --shadow:0 12px 30px rgba(0,0,0,0.35);
    --radius:18px;
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:
      radial-gradient(1200px 700px at 20% 10%, rgba(124,58,237,0.22), transparent 60%),
      radial-gradient(900px 600px at 80% 20%, rgba(34,197,94,0.18), transparent 60%),
      radial-gradient(900px 700px at 50% 100%, rgba(59,130,246,0.16), transparent 60%),
      var(--bg);
    color:var(--text);
    padding:14px;
  }

  /* When an overlay is open, don't scroll the background */
  body.modal-open{
    overflow:hidden;
    touch-action:none;
  }

  .wrap{ max-width:1020px; margin:0 auto; }

  .header{
    padding:16px;
    border:1px solid var(--line);
    border-radius:var(--radius);
    background:linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
    box-shadow:var(--shadow);
    position:relative;
  }

  .topbar{
    display:flex; gap:10px;
    justify-content:space-between;
    align-items:flex-start;
    flex-wrap:wrap;
  }

  h1{ margin:0; font-size:22px; letter-spacing:-0.02em; }

  .meta{
    margin-top:6px;
    color:var(--muted);
    font-size:13px;
    line-height:1.35;
  }

  .controls{
    display:flex; gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }

  select, button, input[type="number"]{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.06);
    color:var(--text);
    outline:none;
    font-size:14px;
  }
  select:focus, button:focus, input[type="number"]:focus{
    border-color:rgba(124,58,237,0.65);
    box-shadow:0 0 0 3px rgba(124,58,237,0.20);
  }

  button{ cursor:pointer; }
  button.danger{
    border-color:rgba(239,68,68,0.35);
    background:rgba(239,68,68,0.10);
  }
  button.ghost{
    border-color:rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.04);
  }

  .adminCorner{
    position:absolute;
    top:12px; right:12px;
    padding:8px 10px;
    font-size:12px;
    border-radius:999px;
  }

  .pills{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,0.06);
    color:var(--muted);
    font-size:12px;
  }

  .dot{ width:8px; height:8px; border-radius:99px; background:var(--purple); }
  .dot.amber{ background:var(--amber); }
  .dot.blue{ background:var(--blue); }
  .dot.pink{ background:var(--pink); }

  .pillToggle{ cursor:pointer; user-select:none; }
  .rateShown{ display:none; margin-left:8px; color:rgba(255,255,255,0.92); }
  .rateHidden{ margin-left:8px; color:rgba(255,255,255,0.55); }
  .pillToggle.open .rateShown{ display:inline; }
  .pillToggle.open .rateHidden{ display:none; }

  .note{
    margin-top:10px;
    color:rgba(34,197,94,0.92);
    font-size:13px;
    display:none;
  }

  .tableCard{
    margin-top:12px;
    border:1px solid var(--line);
    border-radius:var(--radius);
    background:rgba(255,255,255,0.04);
    box-shadow:var(--shadow);
    overflow:hidden;
  }

  table{ width:100%; border-collapse:collapse; }
  thead th{
    text-align:left;
    font-size:12px;
    color:var(--muted);
    padding:12px 12px;
    border-bottom:1px solid var(--line);
    background:rgba(255,255,255,0.05);
    position:sticky;
    top:0;
    backdrop-filter:blur(6px);
  }
  tbody td{
    padding:10px 12px;
    border-bottom:1px solid rgba(255,255,255,0.07);
    font-size:14px;
    vertical-align:middle;
  }
  tbody tr:hover{ background:rgba(255,255,255,0.04); }

  .datecol{ width:260px; font-weight:800; letter-spacing:0.01em; }
  .endcol{ width:160px; }
  .fieldcol{ width:90px; }
  .nightcol{ width:160px; font-variant-numeric:tabular-nums; font-weight:900; }

  /* Date formatting: always 2 lines + colored weekday + weekend red + today highlight */
  .date-wrap{
    display:flex;
    flex-direction:column;
    gap:3px;
    line-height:1.05;
  }
  .date-top{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .date-number{
    font-weight:950;
    font-size:15px;
    letter-spacing:0.02em;
  }
  .date-weekday{
    font-size:12px;
    font-weight:800;
    letter-spacing:0.01em;
    color:#93c5fd;        /* weekday blue-ish */
    opacity:0.9;
  }
  .is-weekend .date-weekday{
    color:#ff4d4d;        /* weekend red */
    opacity:0.95;
  }
  .is-today{
    background:rgba(34,197,94,0.14);
    box-shadow:0 0 10px rgba(34,197,94,0.40);
    border-radius:12px;
  }
  .today-bolt{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:18px;
    height:18px;
    border-radius:999px;
    background:rgba(34,197,94,0.22);
    border:1px solid rgba(34,197,94,0.45);
    box-shadow:0 0 10px rgba(34,197,94,0.35);
  }
  .today-bolt svg{
    width:12px;
    height:12px;
    fill:rgba(34,197,94,0.95);
  }

  input[type="time"]{
    width:120px;
    padding:8px 10px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.16);
    background:rgba(255,255,255,0.06);
    color:var(--text);
    outline:none;
  }

  input[type="password"], input[type="text"]{
    width:100%;
    padding:10px 10px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.16);
    background:rgba(255,255,255,0.06);
    color:var(--text);
    outline:none;
    font-size:14px;
  }

  input[type="checkbox"]{
    transform:scale(1.25);
    accent-color:var(--purple);
    cursor:pointer;
  }

  .grid{ display:grid; gap:12px; grid-template-columns:1fr; margin-top:12px; }

  .box{
    border:1px solid var(--line);
    border-radius:var(--radius);
    background:linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
    box-shadow:var(--shadow);
    padding:14px;
  }
  .row{
    display:flex; gap:14px;
    justify-content:space-between;
    flex-wrap:wrap;
    align-items:flex-start;
  }

  .kpi{ min-width:220px; }
  .kpiTitle{ color:var(--muted); font-size:12px; display:flex; align-items:center; gap:8px; }
  .kpiValue{ font-weight:950; font-size:26px; letter-spacing:-0.02em; }
  .kpiValue.purple{ color:#c4b5fd; }
  .kpiValue.amber{ color:#fcd34d; }
  .kpiValue.blue{ color:#93c5fd; }
  .kpiValue.pink{ color:#f9a8d4; }

  .mini{ margin-top:6px; font-size:12px; color:var(--muted); }
  .money{ white-space:nowrap; }

  .totalBox{
    border:1px solid rgba(34,197,94,0.30);
    background:linear-gradient(180deg, rgba(34,197,94,0.14), rgba(255,255,255,0.04));
  }
  .totalLabel{
    font-size:14px;
    color:rgba(255,255,255,0.75);
    letter-spacing:0.06em;
    font-weight:900;
    text-transform:uppercase;
  }
  .totalBig{
    font-size:46px;
    font-weight:1000;
    color:var(--green);
    letter-spacing:-0.03em;
    margin-top:6px;
  }

  /* overlays */
  .overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.58);
    backdrop-filter:blur(10px);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index:9999;
    overflow:auto;
    -webkit-overflow-scrolling:touch;
  }
  .modal{
    width:100%;
    max-width:520px;
    border:1px solid rgba(255,255,255,0.14);
    border-radius:22px;
    background:linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.05));
    box-shadow:0 18px 70px rgba(0,0,0,0.55);
    padding:16px;
    max-height:90vh;
    overflow:auto;
    -webkit-overflow-scrolling:touch;
  }
  .modalHeader{ display:flex; gap:14px; align-items:center; }
  .meme{
    width:84px; height:84px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.06);
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
    flex:0 0 auto;
  }
  .modal h2{ margin:0; font-size:18px; letter-spacing:-0.02em; }
  .modal p{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35; }
  .modalBody{ margin-top:14px; display:grid; gap:10px; }
  .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .actions button{ flex:1; min-width:140px; }
  .error{ margin-top:8px; color:rgba(239,68,68,0.95); font-size:13px; display:none; }

  .adminOverlay{ justify-content:flex-end; align-items:flex-start; }
  .adminModal{ margin-top:12px; margin-right:12px; max-width:480px; }

  .formGrid{ display:grid; gap:10px; }
  .field{ display:grid; gap:6px; }
  .label{ font-size:12px; color:rgba(255,255,255,0.80); font-weight:800; letter-spacing:0.02em; }
  .help{ font-size:12px; color:rgba(255,255,255,0.55); line-height:1.35; }
  .rateRow{ display:grid; gap:10px; grid-template-columns:1fr 1fr 1fr; }
  @media (max-width:520px){ .rateRow{ grid-template-columns:1fr; } }

  .locked #app{
    filter: blur(7px);
    pointer-events:none;
    user-select:none;
  }

  /* Backup buttons */
  .admin-btn{
    padding:10px 16px;
    border:none;
    border-radius:12px;
    font-weight:900;
    cursor:pointer;
    transition:0.2s;
    color:white;
  }
  .admin-btn:hover{ opacity:0.88; }
  .green-btn{ background:#22c55e; }
  .blue-btn{ background:#3b82f6; }
</style>
</head>

<body class="locked">

<!-- PIN Overlay -->
<div class="overlay" id="pinOverlay" aria-modal="true" role="dialog">
  <div class="modal">
    <div class="modalHeader">
      <div class="meme" aria-hidden="true">
        <!-- Electrician doing X (minimal icon) -->
        <svg viewBox="0 0 120 120" width="84" height="84">
          <defs>
            <linearGradient id="eg4x" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0" stop-color="#7c3aed" stop-opacity="0.75"/>
              <stop offset="1" stop-color="#3b82f6" stop-opacity="0.7"/>
            </linearGradient>
          </defs>
          <rect x="6" y="6" width="108" height="108" rx="22" fill="url(#eg4x)" opacity="0.22"/>
          <rect x="14" y="14" width="92" height="92" rx="18" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.18)"/>
          <!-- Helmet/head -->
          <circle cx="60" cy="44" r="12" fill="rgba(255,255,255,0.20)" stroke="rgba(255,255,255,0.60)" stroke-width="3"/>
          <path d="M48 44 Q60 32 72 44" fill="rgba(255,255,255,0.22)" stroke="rgba(255,255,255,0.60)" stroke-width="3" stroke-linecap="round"/>
          <!-- Body -->
          <path d="M42 90 Q60 70 78 90" fill="rgba(255,255,255,0.16)" stroke="rgba(255,255,255,0.55)" stroke-width="3" stroke-linecap="round"/>
          <!-- Arms crossed (X) -->
          <path d="M36 64 L84 86" stroke="rgba(255,255,255,0.92)" stroke-width="6" stroke-linecap="round"/>
          <path d="M84 64 L36 86" stroke="rgba(255,255,255,0.92)" stroke-width="6" stroke-linecap="round"/>
          <!-- Small lightning -->
          <path d="M70 20 L55 50 H66 L53 86 L79 52 H67 Z" fill="rgba(255,255,255,0.88)" opacity="0.9"/>
        </svg>
      </div>
      <div>
        <h2>Locked</h2>
        <p>Enter PIN to open.</p>
      </div>
    </div>

    <div class="modalBody">
      <input id="pinInput" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="PIN" autocomplete="off">
      <div class="actions">
        <button id="pinUnlock" type="button">Unlock</button>
      </div>
      <div class="error" id="pinError">Wrong PIN.</div>
    </div>
  </div>
</div>

<!-- Admin Overlay -->
<div class="overlay adminOverlay" id="adminOverlay" aria-modal="true" role="dialog">
  <div class="modal adminModal">
    <div class="modalHeader">
      <div class="meme" aria-hidden="true">
        <svg viewBox="0 0 120 120" width="84" height="84">
          <rect x="10" y="10" width="100" height="100" rx="22" fill="rgba(59,130,246,0.18)" stroke="rgba(255,255,255,0.18)"/>
          <path d="M60 30 l20 10 v18c0 18-12 34-20 38c-8-4-20-20-20-38V40z"
                fill="rgba(255,255,255,0.22)" stroke="rgba(255,255,255,0.55)" stroke-width="3"/>
          <text x="60" y="70" text-anchor="middle" fill="rgba(255,255,255,0.92)" font-size="18" font-family="system-ui" font-weight="1000">1997</text>
        </svg>
      </div>
      <div>
        <h2>Admin</h2>
        <p>Security code required.</p>
      </div>
    </div>

    <div class="modalBody">
      <input id="adminCode" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="Security code">
      <div class="actions">
        <button id="adminUnlock" type="button">Unlock</button>
        <button class="ghost" id="adminClose" type="button">Close</button>
      </div>
      <div class="error" id="adminError">Wrong code.</div>

      <div id="adminPanel" style="display:none; margin-top:6px;">
        <div class="mini" style="margin-top:0;">Admin settings (saved on your phone):</div>

        <div class="formGrid" style="margin-top:10px;">
          <div class="field">
            <div class="label">Name</div>
            <input id="setName" type="text" placeholder="e.g. Robert Bodo">
            <div class="help">Shown at the top of the app.</div>
          </div>

          <div class="field">
            <div class="label">Company</div>
            <input id="setCompany" type="text" placeholder="e.g. R - DVS">
            <div class="help">Shown at the top of the app.</div>
          </div>

          <div class="field">
            <div class="label">Rates</div>
            <div class="rateRow">
              <div class="field">
                <input id="setNight" type="number" step="0.01" min="0" placeholder="Night rate">
                <div class="help">£ per night hour.</div>
              </div>
              <div class="field">
                <input id="setField" type="number" step="0.01" min="0" placeholder="Field/day">
                <div class="help">£ per field day.</div>
              </div>
              <div class="field">
                <input id="setFood" type="number" step="0.01" min="0" placeholder="Food/day">
                <div class="help">£ per food day.</div>
              </div>
            </div>
          </div>

          <div class="field">
            <div class="label">Change PIN</div>
            <input id="setPin" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="New PIN (min 4 digits)">
            <div class="help">You can change PIN only here (Admin).</div>
          </div>

          <div class="actions">
            <button id="adminSave" type="button">Save</button>
            <button class="danger" id="adminLock" type="button">Lock</button>
          </div>

          <hr style="margin:20px 0; opacity:0.2;">

          <div>
            <div class="label" style="font-size:14px;">Backup & Restore</div>
            <div class="help" style="margin-top:6px;">
              Before Clear data / reset: Export. After: Import.
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
              <button id="btnExport" class="admin-btn green-btn" type="button">Export Backup</button>
              <button id="btnImport" class="admin-btn blue-btn" type="button">Import Backup</button>
              <input type="file" id="importFile" accept=".json" style="display:none;">
            </div>

            <div class="help" style="margin-top:10px;">
              File: <b>shiftpay-backup.json</b>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<div class="wrap" id="app">
  <div class="header">
    <button class="ghost adminCorner" id="adminBtn" type="button">Admin</button>

    <div class="topbar">
      <div>
        <div class="meta" id="todayLine" style="font-weight:700; font-size:14px;"></div>
        <h1 id="title">Month</h1>
        <div class="meta" id="metaLine">
          <b>Name:</b> Robert Bodo &nbsp;&nbsp; <b>Company:</b> R - DVS
        </div>
      </div>

      <div class="controls">
        <select id="monthSelect" aria-label="Month"></select>
        <input id="yearInput" type="number" min="2000" max="2100" step="1" style="width:110px" aria-label="Year">
        <button class="danger" id="clearMonth" type="button">Clear month</button>
      </div>
    </div>

    <div class="pills">
      <div class="pill pillToggle"><span class="dot"></span>Night rate <span class="rateHidden">• tap</span><span class="rateShown"><b id="pillNight">£3.75</b>/hour</span></div>
      <div class="pill pillToggle"><span class="dot amber"></span>Field day <span class="rateHidden">• tap</span><span class="rateShown"><b id="pillField">£120</b></span></div>
      <div class="pill pillToggle"><span class="dot blue"></span>Food <span class="rateHidden">• tap</span><span class="rateShown"><b id="pillFood">£35</b>/day</span></div>
      <div class="pill pillToggle"><span class="dot pink"></span>Bonus <span class="rateHidden">• tap</span><span class="rateShown">manual</span></div>
      <div class="pill" id="yearPill"></div>
    </div>

    <div class="note" id="migrateNote"></div>
  </div>

  <div class="tableCard">
    <table>
      <thead>
        <tr>
          <th class="datecol">Date</th>
          <th class="endcol">End Time</th>
          <th class="fieldcol">Field</th>
          <th class="nightcol">Night Hours</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="grid">
    <div class="box">
      <div class="row">
        <div class="kpi">
          <div class="kpiTitle"><span class="dot"></span>Night shifts</div>
          <div class="kpiValue purple money" id="nightMoney">0.00 £</div>
          <div class="mini">Total night hours: <span id="nightHours">0:00</span></div>
        </div>

        <div class="kpi">
          <div class="kpiTitle"><span class="dot amber"></span>Field days</div>
          <div class="kpiValue amber money" id="fieldMoney">0.00 £</div>
          <div class="mini">Days worked: <span id="fieldDays">0</span></div>
        </div>

        <div class="kpi">
          <div class="kpiTitle"><span class="dot blue"></span>Food allowance</div>
          <div class="kpiValue blue money" id="foodMoneyBig">0.00 £</div>
          <div class="mini">Days: <input id="foodDays" type="number" min="0" step="1" placeholder="0"></div>
        </div>

        <div class="kpi">
          <div class="kpiTitle"><span class="dot pink"></span>Bonus</div>
          <div class="kpiValue pink money" id="bonusMoneyBig">0.00 £</div>
          <div class="mini">Amount: <input id="bonus" type="number" min="0" step="0.01" placeholder="0.00"></div>
        </div>
      </div>
    </div>

    <div class="box totalBox">
      <div class="totalLabel">TOTAL</div>
      <div class="totalBig money" id="grandTotal">0.00 £</div>
    </div>
  </div>
</div>

<script>
  const DEFAULT_PIN = "9705213";
  const PIN_HASH_KEY = "salary_pin_hash_fixed_v1";
  const ADMIN_CODE = "1997";

  const SETTINGS_KEY = "salary_settings_global_v1";
  const DEFAULTS = { name:"Robert Bodo", company:"R - DVS", nightRate:3.75, fieldRate:120, foodRate:35 };

  const START_MIN = 22 * 60;

  const yearInput = document.getElementById("yearInput");
  yearInput.value = String((new Date()).getFullYear());
  let CURRENT_YEAR = Number(yearInput.value);

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }
  function pad2(n){ return String(n).padStart(2,'0'); }
  function money(x){ return `${(Math.round(x * 100) / 100).toFixed(2)} £`; }
  function toHHMM(minutes){
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return `${h}:${pad2(m)}`;
  }
  function daysInMonth(year, monthIndex){ return new Date(year, monthIndex + 1, 0).getDate(); }
  function nightMinutes(endStr){
    if(!endStr) return 0;
    const parts = endStr.split(":").map(Number);
    const h = parts[0] ?? 0, m = parts[1] ?? 0;
    let endMin = h * 60 + m;
    if(endMin < START_MIN) endMin += 24 * 60;
    return Math.max(0, endMin - START_MIN);
  }

  function setTodayLine(){
    const el = document.getElementById("todayLine");
    if(!el) return;
    const now = new Date();
    const date = now.toLocaleDateString("en-GB", { day:"2-digit", month:"2-digit", year:"numeric" });
    const weekday = now.toLocaleDateString("en-GB", { weekday:"long" });
    el.textContent = `${date} (${weekday})`;
  }

  async function sha256(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
  }

  function loadSettings(){
    try{
      const raw = localStorage.getItem(SETTINGS_KEY);
      if(!raw) return { ...DEFAULTS };
      const s = JSON.parse(raw);
      return {
        name: typeof s.name === "string" ? s.name : DEFAULTS.name,
        company: typeof s.company === "string" ? s.company : DEFAULTS.company,
        nightRate: Number.isFinite(Number(s.nightRate)) ? Number(s.nightRate) : DEFAULTS.nightRate,
        fieldRate: Number.isFinite(Number(s.fieldRate)) ? Number(s.fieldRate) : DEFAULTS.fieldRate,
        foodRate: Number.isFinite(Number(s.foodRate)) ? Number(s.foodRate) : DEFAULTS.foodRate
      };
    }catch(e){
      return { ...DEFAULTS };
    }
  }
  function saveSettings(s){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }
  let SETTINGS = loadSettings();

  function refreshMetaAndRates(){
    document.getElementById("metaLine").innerHTML =
      `<b>Name:</b> ${escapeHtml(SETTINGS.name)} &nbsp;&nbsp; <b>Company:</b> ${escapeHtml(SETTINGS.company)}`;
    document.getElementById("pillNight").textContent = `£${SETTINGS.nightRate}`;
    document.getElementById("pillField").textContent = `£${SETTINGS.fieldRate}`;
    document.getElementById("pillFood").textContent  = `£${SETTINGS.foodRate}`;
  }

  const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const monthSelect = document.getElementById("monthSelect");
  MONTHS.forEach((name, idx) => {
    const opt = document.createElement("option");
    opt.value = String(idx);
    opt.textContent = name;
    monthSelect.appendChild(opt);
  });
  monthSelect.value = String((new Date()).getMonth());

  function setYearPill(){ document.getElementById("yearPill").textContent = `Year: ${CURRENT_YEAR}`; }

  function legacyFebKey(year){ return `night_hours_feb_${year}`; }
  function monthKey(year, monthIndex){
    if(monthIndex === 1) return legacyFebKey(year);
    return `salary_${year}_${monthIndex}`;
  }

  function loadRaw(key){
    try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : null; }
    catch(e){ return null; }
  }
  function saveRaw(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
  function isNewFormat(obj){ return obj && typeof obj === "object" && obj.days && typeof obj.days === "object"; }

  function migrateIfNeededForKey(key, year, monthIndex){
    const note = document.getElementById("migrateNote");
    note.style.display = "none";
    note.textContent = "";

    if(monthIndex !== 1) return;

    const raw = loadRaw(key);
    if(!raw) return;
    if(isNewFormat(raw)) return;

    let migratedCount = 0;
    const newObj = { days: {}, foodDays: 0, bonus: 0 };

    for (const k of Object.keys(raw)) {
      const v = raw[k];
      if (typeof v === "string" && v.includes(":")) {
        newObj.days[k] = { endTime: v, field: false };
        migratedCount++;
      }
    }

    if(migratedCount > 0){
      saveRaw(key, newObj);
      note.style.display = "block";
      note.textContent = `Imported ${migratedCount} saved days ✅ (${MONTHS[monthIndex]} ${year})`;
    }
  }

  function loadData(key){
    const raw = loadRaw(key);
    if(!raw) return { days: {}, foodDays: 0, bonus: 0 };

    if(isNewFormat(raw)){
      return { days: raw.days || {}, foodDays: Number(raw.foodDays || 0), bonus: Number(raw.bonus || 0) };
    }

    const days = {};
    for(const k of Object.keys(raw)){
      const v = raw[k];
      if(typeof v === "string" && v.includes(":")) days[k] = { endTime: v, field: false };
    }
    return { days, foodDays: 0, bonus: 0 };
  }

  function saveData(key, data){
    saveRaw(key, { days: data.days || {}, foodDays: Number(data.foodDays || 0), bonus: Number(data.bonus || 0) });
  }

  function recalc(key){
    const data = loadData(key);

    let totalNightMin = 0;
    let fieldDays = 0;

    for(const dStr of Object.keys(data.days)){
      const entry = data.days[dStr] || {};
      if(entry.endTime) totalNightMin += nightMinutes(entry.endTime);
      if(entry.field === true) fieldDays += 1;
    }

    const nightPay = (totalNightMin / 60) * SETTINGS.nightRate;
    const fieldPay = fieldDays * SETTINGS.fieldRate;

    const foodDays = Number(data.foodDays || 0);
    const foodPay = foodDays * SETTINGS.foodRate;

    const bonus = Number(data.bonus || 0);
    const grand = nightPay + fieldPay + foodPay + bonus;

    document.getElementById("nightHours").textContent = toHHMM(totalNightMin);
    document.getElementById("nightMoney").textContent = money(nightPay);

    document.getElementById("fieldDays").textContent = String(fieldDays);
    document.getElementById("fieldMoney").textContent = money(fieldPay);

    document.getElementById("foodMoneyBig").textContent = money(foodPay);
    document.getElementById("bonusMoneyBig").textContent = money(bonus);

    document.getElementById("grandTotal").textContent = money(grand);
  }

  function isSameYMD(a, b){
    return a.getFullYear() === b.getFullYear() &&
           a.getMonth() === b.getMonth() &&
           a.getDate() === b.getDate();
  }

  function renderMonth(){
    const monthIndex = Number(monthSelect.value);
    const year = CURRENT_YEAR;
    const key = monthKey(year, monthIndex);

    document.getElementById("title").textContent = `${MONTHS[monthIndex]}`;
    migrateIfNeededForKey(key, year, monthIndex);

    const data = loadData(key);

    const foodDaysEl = document.getElementById("foodDays");
    const bonusEl = document.getElementById("bonus");

    foodDaysEl.value = String(data.foodDays ?? 0);
    bonusEl.value = String(data.bonus ?? 0);

    foodDaysEl.oninput = () => {
      const cur = loadData(key);
      const v = Number(foodDaysEl.value || 0);
      cur.foodDays = Number.isFinite(v) && v >= 0 ? v : 0;
      saveData(key, cur);
      recalc(key);
    };

    bonusEl.oninput = () => {
      const cur = loadData(key);
      const v = Number(bonusEl.value || 0);
      cur.bonus = Number.isFinite(v) && v >= 0 ? v : 0;
      saveData(key, cur);
      recalc(key);
    };

    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    const dmax = daysInMonth(year, monthIndex);
    const mm = pad2(monthIndex + 1);

    const today = new Date();

    for(let d=1; d<=dmax; d++){
      const date = new Date(year, monthIndex, d);
      const weekday = date.toLocaleDateString("en-GB", { weekday: "long" });
      const dow = date.getDay(); // 0 Sun, 6 Sat

      const tr = document.createElement("tr");

      if(isSameYMD(date, today)) tr.classList.add("is-today");

      const tdDate = document.createElement("td");
      tdDate.className = "datecol";

      const wrap = document.createElement("div");
      wrap.className = "date-wrap";

      const top = document.createElement("div");
      top.className = "date-top";

      const dn = document.createElement("div");
      dn.className = "date-number";
      dn.textContent = `${pad2(d)}.${mm}`;

      top.appendChild(dn);

      if(isSameYMD(date, today)){
        const bolt = document.createElement("span");
        bolt.className = "today-bolt";
        bolt.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M13 2L3 14h7l-1 8 12-14h-7l-1-6z"/></svg>';
        top.appendChild(bolt);
      }

      const dw = document.createElement("div");
      dw.className = "date-weekday";
      dw.textContent = weekday;

      if(dow === 0 || dow === 6){
        tr.classList.add("is-weekend");
      }

      wrap.appendChild(top);
      wrap.appendChild(dw);
      tdDate.appendChild(wrap);
      tr.appendChild(tdDate);

      const tdEnd = document.createElement("td");
      tdEnd.className = "endcol";
      const endInput = document.createElement("input");
      endInput.type = "time";
      endInput.step = 60;
      const entry = (data.days && data.days[d]) ? data.days[d] : {};
      endInput.value = entry.endTime || "";
      tdEnd.appendChild(endInput);
      tr.appendChild(tdEnd);

      const tdField = document.createElement("td");
      tdField.className = "fieldcol";
      const fieldCb = document.createElement("input");
      fieldCb.type = "checkbox";
      fieldCb.checked = entry.field === true;
      tdField.appendChild(fieldCb);
      tr.appendChild(tdField);

      const tdNight = document.createElement("td");
      tdNight.className = "nightcol";
      tdNight.textContent = endInput.value ? toHHMM(nightMinutes(endInput.value)) : "—";
      tr.appendChild(tdNight);

      endInput.oninput = () => {
        const cur = loadData(key);
        if(!cur.days) cur.days = {};
        if(!cur.days[d]) cur.days[d] = { field: false };

        if(endInput.value){
          cur.days[d].endTime = endInput.value;
          cur.days[d].field = true;
          fieldCb.checked = true;
        }else{
          delete cur.days[d].endTime;
          cur.days[d].field = false;
          fieldCb.checked = false;
        }

        const hasEnd = !!cur.days[d].endTime;
        const hasField = cur.days[d].field === true;
        if(!hasEnd && !hasField) delete cur.days[d];

        saveData(key, cur);
        tdNight.textContent = endInput.value ? toHHMM(nightMinutes(endInput.value)) : "—";
        recalc(key);
      };

      fieldCb.onchange = () => {
        const cur = loadData(key);
        if(!cur.days) cur.days = {};
        if(!cur.days[d]) cur.days[d] = {};
        cur.days[d].field = fieldCb.checked;

        const hasEnd = !!cur.days[d].endTime;
        const hasField = cur.days[d].field === true;
        if(!hasEnd && !hasField) delete cur.days[d];

        saveData(key, cur);
        recalc(key);
      };

      tbody.appendChild(tr);
    }

    recalc(key);

    document.getElementById("clearMonth").onclick = () => {
      localStorage.removeItem(key);
      renderMonth();
    };
  }

  document.querySelectorAll(".pillToggle").forEach(pill => {
    pill.addEventListener("click", () => {
      document.querySelectorAll(".pillToggle").forEach(p => { if(p !== pill) p.classList.remove("open"); });
      pill.classList.toggle("open");
    });
  });

  monthSelect.onchange = () => renderMonth();

  function applyYearChange(){
    const y = Number(yearInput.value);
    if(!Number.isFinite(y) || y < 2000 || y > 2100) return;
    CURRENT_YEAR = y;
    setYearPill();
    renderMonth();
  }
  yearInput.addEventListener("change", applyYearChange);
  yearInput.addEventListener("keydown", (e) => { if(e.key === "Enter") applyYearChange(); });

  function openOverlay(id){
    document.getElementById(id).style.display = "flex";
    document.body.classList.add("modal-open");
  }
  function closeOverlay(id){
    document.getElementById(id).style.display = "none";
    const pinOpen = document.getElementById("pinOverlay").style.display === "flex";
    const adminOpen = document.getElementById("adminOverlay").style.display === "flex";
    if(!pinOpen && !adminOpen) document.body.classList.remove("modal-open");
  }

  async function ensurePinInitialized(){
    const stored = localStorage.getItem(PIN_HASH_KEY);
    if(!stored){
      localStorage.setItem(PIN_HASH_KEY, await sha256(DEFAULT_PIN));
    }
  }

  function showPin(){
    openOverlay("pinOverlay");
    document.getElementById("pinError").style.display = "none";
    document.getElementById("pinInput").value = "";
    setTimeout(() => document.getElementById("pinInput").focus(), 60);
  }

  function hidePin(){
    closeOverlay("pinOverlay");
    document.body.classList.remove("locked");
  }

  let pinTryToken = 0;
  async function tryUnlockAuto(){
    const input = document.getElementById("pinInput");
    const pin = (input.value || "").trim();
    const err = document.getElementById("pinError");
    const stored = localStorage.getItem(PIN_HASH_KEY);

    if(pin.length < 4){
      err.style.display = "none";
      return;
    }

    const myToken = ++pinTryToken;
    const hash = await sha256(pin);
    if(myToken !== pinTryToken) return;

    if(hash === stored){
      err.style.display = "none";
      hidePin();
      refreshMetaAndRates();
      setYearPill();
      setTodayLine();
      renderMonth();
    }
  }

  async function unlockWithPin(){
    const pin = (document.getElementById("pinInput").value || "").trim();
    const err = document.getElementById("pinError");
    const stored = localStorage.getItem(PIN_HASH_KEY);

    if(pin.length < 4){
      err.textContent = "PIN too short.";
      err.style.display = "block";
      return;
    }

    const hash = await sha256(pin);
    if(hash === stored){
      err.style.display = "none";
      hidePin();
      refreshMetaAndRates();
      setYearPill();
      setTodayLine();
      renderMonth();
    } else {
      err.textContent = "Wrong PIN.";
      err.style.display = "block";
    }
  }

  document.getElementById("pinUnlock").addEventListener("click", unlockWithPin);
  document.getElementById("pinInput").addEventListener("keydown", (e) => { if(e.key === "Enter") unlockWithPin(); });
  document.getElementById("pinInput").addEventListener("input", () => { tryUnlockAuto(); });

  let adminUnlocked = false;

  function showAdmin(){
    openOverlay("adminOverlay");
    document.getElementById("adminError").style.display = "none";
    document.getElementById("adminCode").value = "";
    document.getElementById("adminPanel").style.display = "none";
    adminUnlocked = false;
    setTimeout(() => document.getElementById("adminCode").focus(), 60);
  }
  function hideAdmin(){ closeOverlay("adminOverlay"); }

  document.getElementById("adminBtn").addEventListener("click", showAdmin);
  document.getElementById("adminClose").addEventListener("click", hideAdmin);

  document.getElementById("adminUnlock").addEventListener("click", () => {
    const code = (document.getElementById("adminCode").value || "").trim();
    const err = document.getElementById("adminError");

    if(code !== ADMIN_CODE){
      err.style.display = "block";
      err.textContent = "Wrong code.";
      return;
    }

    err.style.display = "none";
    adminUnlocked = true;

    document.getElementById("setName").value = SETTINGS.name;
    document.getElementById("setCompany").value = SETTINGS.company;
    document.getElementById("setNight").value = SETTINGS.nightRate;
    document.getElementById("setField").value = SETTINGS.fieldRate;
    document.getElementById("setFood").value = SETTINGS.foodRate;
    document.getElementById("setPin").value = "";

    document.getElementById("adminPanel").style.display = "block";
  });

  document.getElementById("adminSave").addEventListener("click", async () => {
    if(!adminUnlocked) return;

    const name = (document.getElementById("setName").value || "").trim() || DEFAULTS.name;
    const company = (document.getElementById("setCompany").value || "").trim() || DEFAULTS.company;

    const night = Number(document.getElementById("setNight").value);
    const field = Number(document.getElementById("setField").value);
    const food  = Number(document.getElementById("setFood").value);

    SETTINGS = {
      name,
      company,
      nightRate: Number.isFinite(night) && night >= 0 ? night : DEFAULTS.nightRate,
      fieldRate: Number.isFinite(field) && field >= 0 ? field : DEFAULTS.fieldRate,
      foodRate:  Number.isFinite(food) && food >= 0 ? food : DEFAULTS.foodRate
    };
    saveSettings(SETTINGS);

    const newPin = (document.getElementById("setPin").value || "").trim();
    if(newPin){
      if(newPin.length < 4){
        alert("New PIN too short (min 4 digits).");
        return;
      }
      localStorage.setItem(PIN_HASH_KEY, await sha256(newPin));
    }

    refreshMetaAndRates();
    renderMonth();
    hideAdmin();
  });

  document.getElementById("adminLock").addEventListener("click", () => {
    adminUnlocked = false;
    hideAdmin();
  });

  function exportData(){
    const backup = {};
    for (let i = 0; i < localStorage.length; i++){
      const k = localStorage.key(i);
      backup[k] = localStorage.getItem(k);
    }
    const blob = new Blob([JSON.stringify(backup)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "shiftpay-backup.json";
    a.click();
    URL.revokeObjectURL(url);
    alert("Backup exported ✅");
  }

  function importDataFromFile(file){
    const reader = new FileReader();
    reader.onload = (event) => {
      let data;
      try{ data = JSON.parse(event.target.result); }
      catch(e){ alert("Invalid file (not JSON)."); return; }

      for(const key in data){
        localStorage.setItem(key, data[key]);
      }

      alert("Backup imported ✅");
      location.reload();
    };
    reader.readAsText(file);
  }

  document.getElementById("btnExport").addEventListener("click", exportData);
  document.getElementById("btnImport").addEventListener("click", () => document.getElementById("importFile").click());
  document.getElementById("importFile").addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const ok = confirm("Import will overwrite current data. Continue?");
    if(!ok){ e.target.value = ""; return; }
    importDataFromFile(file);
  });

  // Auto-lock when app loses focus
  let lockTimer = null;
  function lockNow(){
    if (document.body.classList.contains("locked")) return;
    try { document.getElementById("adminOverlay").style.display = "none"; } catch(e){}
    document.body.classList.add("locked");
    showPin();
  }
  function scheduleLock(){
    clearTimeout(lockTimer);
    lockTimer = setTimeout(lockNow, 0);
  }
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") scheduleLock();
  });
  window.addEventListener("pagehide", scheduleLock);
  window.addEventListener("blur", scheduleLock);

  refreshMetaAndRates();
  setYearPill();
  setTodayLine();

  (async () => {
    await ensurePinInitialized();
    showPin();
  })();
</script>

<!-- AUTO UPDATE service worker (auto refresh when update is available) -->
<script>
(function () {
  if (!("serviceWorker" in navigator)) return;

  navigator.serviceWorker.register("./sw.js", { scope: "./" }).then((reg) => {
    setInterval(() => reg.update(), 30000);

    reg.addEventListener("updatefound", () => {
      const nw = reg.installing;
      if (!nw) return;
      nw.addEventListener("statechange", () => {
        if (nw.state === "installed" && navigator.serviceWorker.controller) {
          if (reg.waiting) reg.waiting.postMessage({ type: "SKIP_WAITING" });
        }
      });
    });

    if (reg.waiting && navigator.serviceWorker.controller) {
      reg.waiting.postMessage({ type: "SKIP_WAITING" });
    }
  });

  let refreshing = false;
  navigator.serviceWorker.addEventListener("controllerchange", () => {
    if (refreshing) return;
    refreshing = true;
    window.location.reload();
  });
})();
</script>

</body>
</html>
